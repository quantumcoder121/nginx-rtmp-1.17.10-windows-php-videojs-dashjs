worker_processes  1;

error_log  logs/error.log;

events {
    worker_connections  1024;
}

rtmp {
    server {
	listen 1935;
	access_log logs/rtmp_access.log;

	application live {
	        live on;
	    	# record_path temp/recordings;
		# record_suffix all-%d-%b-%y-%T.flv;
		# record_max_size 128K;
		# record_interval 30s;
		# record keyframes;

		push rtmp://localhost/hls;
		push rtmp://localhost/dash;
		# push rtmp://localhost/youtube;
		}
	
	application hls {
	        live on;
		hls_nested on;
		hls_cleanup on;
		hls_sync 100ms;
		hls_fragment 10s;
		hls_playlist_length 60s;
		hls_path temp/hls_temp;
		}

	application dashjs {
	        live on;
		dash_nested on;
		dash_cleanup on;
		dash_fragment 10s;
		dash_playlist_length 60s;
		dash_path temp/dash_temp;
		}

	#application youtube {
	        live on;
	        #push rtmp://a.rtmp.youtube.com/live2/YOUR_STREAM_KEY;
		#allow publish 127.0.0.1;
		#deny publish all;
		#}
	}
}

http {

    keepalive_timeout	60;
    send_timeout        10;
    keepalive_requests  10;
    client_body_timeout 10;

    #gzip		on;
    sendfile		on;
    include		mime.types;
    default_type	application/octet-stream;

    log_format	main  '$remote_addr - $remote_user [$time_local] "$request" '
	                  '$status $body_bytes_sent "$http_referer" '
	                  '"$http_user_agent" "$http_x_forwarded_for"';
    access_log	logs/access.log  main;

    server {

	listen		8050;
	# listen [::]:	8050;

	server_name	localhost;
	access_log	logs/host.access.log  main;
	add_header	Strict-Transport-Security "max-age=63072000;";

        ## Deny access to .htaccess files, if Apache's document root concurs with nginx's one
        #location ~ /\.ht {
	#	deny  all;
	#	}

        error_page   500 502 503 504  /50x.html;
		location = /50x.html {
		root   html;
		}

        location ~ \.php$ {
		include        fastcgi_params;
		fastcgi_pass   127.0.0.1:9000;
		fastcgi_index  index.php;
		fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
		}

	location / {
		root html;
		index index.php index.html index-nginx.html index.htm;
		}

        location /stat {
		rtmp_stat all;
		rtmp_stat_stylesheet stat.xsl;
		# auth_basic "Restricted Content";
		# auth_basic_user_file .htpasswd;
		}

        location /stat.xsl {
		root html;
		}

        location /control {
		rtmp_control all;
		# auth_basic "stream";
		# auth_basic_user_file .htpasswd;
		}

        #location /publish {
        #    return 201;
        #}
        #location /play {
        #    return 202;
        #}
        #location /record_done {
        #    return 203;
        #}

        location /hls {
            types{  
                application/vnd.apple.mpegurl m3u8;  
                video/mp2t ts;  
            }  
            alias temp/hls_temp;  
            expires -1;
	    # autoindex on;
		add_header Cache-Control no-cache;
			if ($request_method = 'OPTIONS') {
			add_header 'Access-Control-Allow-Origin' '*';
			add_header 'Access-Control-Max-Age' 1728000;
			add_header 'Content-Type' 'text/plain charset=UTF-8';
			add_header 'Content-Length' 0;
			return 204;
			}
		}

        location /dashjs {
            types{  
		application/dash+xml mpd;
		video/mp4 mp4;
	    }  
            alias temp/dash_temp;  
            expires -1;
	    # autoindex on;
		add_header Cache-Control no-cache;
			if ($request_method = 'OPTIONS') {
			add_header 'Access-Control-Allow-Origin' '*';
			add_header 'Access-Control-Max-Age' 1728000;
			add_header 'Content-Type' 'text/plain charset=UTF-8';
			add_header 'Content-Length' 0;
			return 204;
			}
		}
	}


## OPTIONAL HTTPS SSL SETUP ##

    #server {
	#listen	8851 ssl http2;
	#listen [::]:	8851 ssl http2;
	#server_name  _default;

	#ssl_certificate      certs/cert.pem;
	#ssl_certificate_key  certs/privkey.key;
	#ssl_session_cache    shared:SSL:1m;
	#ssl_session_timeout  5m;

	#ssl_ciphers  HIGH:!aNULL:!MD5;
	#ssl_prefer_server_ciphers  on;

	#location / {
	#	root   html;
	#	index  index.html index.htm;
	#	}
	#}
}
